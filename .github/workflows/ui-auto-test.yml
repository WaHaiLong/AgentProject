# 工作流名称
name: Vue+C# UI自动化测试

# 触发条件：main分支提交代码、PR合并时触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 任务配置
jobs:
  ui-auto-test:
    # 运行环境：GitHub提供的Ubuntu虚拟机
    runs-on: ubuntu-latest

    steps:
      # 步骤1：拉取GitHub仓库代码
      - name: 拉取代码
        uses: actions/checkout@v4

      # 新增：启动SQL Server测试容器（跑完自动销毁）
      - name: 启动SQL Server测试容器
        run: |
          docker run -d \
            --name test-sqlserver \
            -e ACCEPT_EULA=Y \
            -e SA_PASSWORD=StrongPass@123456 \
            -e MSSQL_PID=Express \
            -p 1433:1433 \
            mcr.microsoft.com/mssql/server:2022-latest

      # 等待SQL Server就绪（关键：避免服务未启动就连接）
      - name: 等待SQL Server启动完成
        run: |
          until docker exec test-sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P StrongPass@123456 -Q "SELECT 1" > /dev/null 2>&1; do
            echo "等待SQL Server启动..."
            sleep 5
          done
          # 创建测试数据库（bill_test_db）
          docker exec test-sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P StrongPass@123456 -Q "CREATE DATABASE bill_test_db;"

      # 步骤2：配置C#运行环境（.NET SDK）
      - name: 安装.NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # 适配你的C#后端SDK版本（如6.0.x/7.0.x）

      # 步骤3：启动C#后端服务（后台运行）
      - name: 启动C#后端服务
        working-directory: ./vue-csharp-ui-auto/Backend  # 后端项目目录
        env:
          ASPNETCORE_ENVIRONMENT: Test  # 关键：切换到测试配置
        run: |
          dotnet restore  # 还原依赖
          dotnet build    # 编译项目
          # 启动后端服务（后台运行，绑定0.0.0.0允许外部访问）
          nohup dotnet run --urls=http://0.0.0.0:5000 &
          sleep 10  # 延长等待，确保数据库迁移完成
          # 检查后端服务是否启动成功
          echo "检查后端服务状态..."
          timeout 30 bash -c 'until curl -f http://localhost:5000/api/health; do sleep 2; done'

      # 步骤4：配置Node.js环境（运行Vue前端）
      - name: 安装Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'  # 适配你的Vue项目Node版本
          # cache: 'npm'
          # cache-dependency-path: ./vue-csharp-ui-auto/Frontend/package-lock.json

      # 步骤5：启动Vue前端服务（后台运行）
      - name: 启动Vue前端服务
        working-directory: ./vue-csharp-ui-auto/Frontend  # 前端项目目录
        run: |
          npm install  # 安装前端依赖
          # 启动Vue服务（后台运行，绑定0.0.0.0）
          nohup npm run serve -- --host 0.0.0.0 --port 8080 &
          # 等待前端服务启动（休眠15秒，Vue启动较慢）
          sleep 15
          echo "前端服务已启动"

      # 步骤6：安装Chrome浏览器（适配UI自动化）
      - name: 安装Chrome
        run: |
          sudo apt update
          sudo apt install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt update
          sudo apt install -y google-chrome-stable

      # 步骤7：安装ChromeDriver
      - name: 安装ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
          CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_VERSION%.*.*}")
          wget -O /tmp/chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver-linux64/chromedriver
          echo "CHROME_DRIVER_PATH=/usr/local/bin/chromedriver-linux64/chromedriver" >> $GITHUB_ENV

      # 步骤8：配置Python环境（运行UI自动化脚本）
      - name: 安装Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 步骤8.1：安装SQL Server ODBC驱动
      - name: 安装SQL Server ODBC驱动
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc unixodbc-dev
          sudo apt-get install -y msodbcsql17  # SQL Server ODBC驱动

      # 步骤9：安装Python测试依赖
      - name: 安装测试依赖
        working-directory: ./vue-csharp-ui-auto/UiAutoTest
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 步骤10：运行UI自动化测试（失败也保留报告）
      - name: 执行UI自动化测试
        working-directory: ./vue-csharp-ui-auto/UiAutoTest
        run: |
          pytest test_vue_page.py --html=ui-test-report.html --self-contained-html || echo "UI测试完成，可能有失败项"
          pytest test_bill_api.py --html=sql-test-report.html --self-contained-html || echo "SQL Server接口测试完成，可能有失败项"

      # 步骤11：上传UI测试报告（方便查看）
      - name: 上传UI测试报告
        uses: actions/upload-artifact@v4
        with:
          name: vue-csharp-ui-test-report
          path: ./vue-csharp-ui-auto/UiAutoTest/ui-test-report.html
          retention-days: 7  # 报告保留7天

      # 步骤11.1：上传SQL Server接口测试报告
      - name: 上传SQL Server接口测试报告
        uses: actions/upload-artifact@v4
        with:
          name: sql-server-api-test-report
          path: ./vue-csharp-ui-auto/UiAutoTest/sql-test-report.html
          retention-days: 7  # 报告保留7天

      # 步骤12：上传日志文件（用于调试）
      # 暂时注释前端日志上传，避免路径错误
      # - name: 上传前端日志
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: frontend-logs
      #     path: ./vue-csharp-ui-auto/Frontend/frontend.log
      #     retention-days: 7