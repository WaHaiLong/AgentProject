name: Deploy to Server

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: self-hosted  # 使用自托管运行器
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Build Backend
        working-directory: ./Backend
        run: |
          dotnet restore
          dotnet publish --configuration Release --output ./publish
          
      - name: Deploy Frontend Only
        run: |
          # Create frontend directory
          sudo mkdir -p /var/www/vue-csharp-frontend
          
          # Copy frontend files
          sudo cp -r Frontend/dist/* /var/www/vue-csharp-frontend/
          sudo chown -R www-data:www-data /var/www/vue-csharp-frontend
          
          # Verify frontend files were deployed
          echo "Frontend files deployed:"
          sudo ls -la /var/www/vue-csharp-frontend/
          
          # Configure Nginx for frontend
          sudo tee /etc/nginx/sites-available/vue-csharp-frontend > /dev/null <<EOF
          server {
              listen 80;
              server_name _;
              
              location / {
                  root /var/www/vue-csharp-frontend;
                  index index.html;
                  try_files $uri $uri/ /index.html;
              }
              
              # For API requests, return 404 or redirect as needed
              location /api/ {
                  return 404 "API server not available";
              }
          }
          EOF
          
          sudo ln -sf /etc/nginx/sites-available/vue-csharp-frontend /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "✅ Frontend deployed and Nginx configured"
          
      - name: Build Frontend
        working-directory: ./Frontend
        run: |
          npm ci
          npm run build
          
      - name: Stop existing services
        run: |
          # Check if services exist before stopping
          if sudo systemctl list-units --type=service | grep -q vue-csharp-backend; then
            sudo systemctl stop vue-csharp-backend
            echo "Stopped existing vue-csharp-backend service"
          else
            echo "vue-csharp-backend service does not exist yet"
          fi
          
          if sudo systemctl list-units --type=service | grep -q vue-csharp-frontend; then
            sudo systemctl stop vue-csharp-frontend
            echo "Stopped existing vue-csharp-frontend service"
          else
            echo "vue-csharp-frontend service does not exist yet"
          fi
          
          # Kill any running backend processes
          sudo pkill -f "dotnet.*Backend.dll" || true
          echo "Killed any existing backend processes"
          
      - name: Verify Frontend Deployment
        run: |
          # Wait for Nginx to be ready
          sleep 5
          
          # Check if Nginx is running
          echo "Checking Nginx status:"
          sudo systemctl status nginx --no-pager
          
          # Check if port 80 is listening
          echo "Checking if port 80 is listening..."
          sudo netstat -tlnp | grep :80 || echo "Port 80 not found listening"
          
          # Test the frontend
          echo "Testing frontend access..."
          curl -v http://localhost/ || {
            echo "Frontend check failed"
            exit 1
          }
          
          echo "✅ Frontend deployment successful"
          
      - name: Create deployment notification
        run: |
          echo "✅ Frontend application successfully deployed to production server"
          echo "Frontend: http://localhost:80"